
# 03. 服务器性能剖析

最常碰到的和性能相关的问题是：如何确认服务器是否到到了性能最佳的状态，找到某条语句为什么执行不够快，以及诊断被用户描述成“停顿”、“堆积”或者“卡死”的某些间歇性疑难故障。这些看起来很艰巨的任务事实上有个简单方法：（使用性能剖析技术）专注于测量服务器的时间花费在哪里。

## 3.1 性能优化简介

性能即响应时间，为完成某件任务所需要的时间度量。性能优化就是在一定的工作负载下尽可能地降低响应时间。
- 认为性能优化就是降低CPU利用率是一个陷阱，CPU利用率只是一个现象，而不是很好的可度量目标。
- 性能优化往往带来吞吐量（单位时间内的查询数量）的提升
- 为了降低响应时间，那就需要理解为什么服务器执行查询需要这么多时间，然后去减少或消除对获得查询结果来说不必要的工作。也就是要搞清楚时间花在了什么地方。
  - 无法测量就无法有效优化。很多人优化时将精力放在修改一些东西，正确做法应该是：花费绝大部分时间来测量响应时间花在哪里。
    - 测量很具挑战，包括分析测试结果。通过测量如果没有找到答案，要么测试方式错误，要么测试不够完整。
      - 需要合适的测试范围：只测试需要优化的活动。（不合适的范围：错误时间启动停止测试；测试是聚合后的信息，而不是目标活动本身；）
        - 例如：常见的一个错误是先查看慢查询，再去排查整个服务器情况去判断问题在哪里。如果确认有慢查询，测试应该是从慢查询开始到结束的时间，而不是查询之前或查询之后的时间。
      - 完成一项任务需要的时间分为：执行时间和等待时间。
        - 优化执行时间，最好通过测量定位不同的子任务花费的时间，然后有和去掉一些任务、降低子任务的频率或者提升子任务的效率；
        - 优化等待时间相对复杂，可能是其他系统间接导致，任务直接也可能争用CPU或磁盘资源而相互影响；

### 3.1.1 通过性能剖析进行优化

性能剖析是测量和分析时间花费在哪里的主要方法。性能剖析一般有两个步骤：测量任务所花费的时间；然后对结果进行统计和排序，将重要的任务排在前面；

### 3.1.2 理解性能剖析
## 3.2 对应用程序进行性能剖析
### 3.2.1 测量 PHP 应用程序
## 3.3 剖析 Mysql 查询
### 3.3.1 剖析服务器负载
### 3.3.2 剖析单条查询
### 3.3.3 使用性能剖析
## 3.4 诊断间歇性问题
### 3.4.1 单条查询还是服务器的问题 
### 3.4.2 捕获诊断数据
### 3.4.3 一个诊断案例 
## 3.5 其他剖析工具
### 3.5.1 使用 USER_STATISTICS 表
### 3.5.2 使用 strace